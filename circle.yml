machine:
  php:
    # We support PHP 5.4 so choose the latest version supported by Circle.
    version: 5.4.37
  environment:
    # This is where we build our complete Drupal site
    DING_BUILD_PATH: /tmp/drupal

dependencies:
  post:
    # Install drush globally using composer.
    # Prefer source to get around GitHub API rate limits.
    - composer global require drush/drush:6.*  --prefer-source --no-interaction

test:
  override:
    # Build profile using drush make
    - drush make ding2.make --no-core --contrib-destination=. -y
  post:
    # Built an entire Drupal site with core, contrib and custom code and make
    # it available as an artifact.
    # First we build Drupal core only. Instead of using the profile specified in
    # the make  file we use the one we have just build.
    # This way we do not have to update drupal.make for each build.
    - drush make drupal.make --projects=drupal -y $DING_BUILD_PATH
    # Copy the current profile which has just been built into Drupal core
    - mkdir $DING_BUILD_PATH/profiles/ding2
    - cp -R ./* $DING_BUILD_PATH/profiles/ding2/
    # Wrap the site into an archieve and expose it as an artifact.
    - tar -zcvf $CIRCLE_ARTIFACTS/ding2-$CIRCLE_SHA1.tar.gz -C $DING_BUILD_PATH .
